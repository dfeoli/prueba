name: Validar archivo .sch único (estricto)

on:
  push:
    branches:
      - main
      - develop

jobs:
  check-single-sch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Trae todo el historial para poder comparar commits

      - name: Obtener archivos cambiados en el push
        id: files
        run: |
          # Caso push inicial en la rama
          if [ "${GITHUB_EVENT_BEFORE}" = "0000000000000000000000000000000000000000" ]; then
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r $GITHUB_SHA)
          else
            # Obtener todos los commits del push
            COMMITS=$(git rev-list $GITHUB_EVENT_BEFORE..$GITHUB_SHA)
            CHANGED_FILES=""
            for commit in $COMMITS; do
              FILES=$(git diff-tree --no-commit-id --name-only -r $commit)
              CHANGED_FILES="$CHANGED_FILES $FILES"
            done
          fi

          # Limpiar duplicados
          CHANGED_FILES=$(echo $CHANGED_FILES | tr ' ' '\n' | sort -u | tr '\n' ' ')
          echo "Archivos cambiados: $CHANGED_FILES"
          echo "changed=$CHANGED_FILES" >> $GITHUB_ENV

      - name: Validar archivo único .sch
        run: |
          FILES=($changed)
          COUNT=${#FILES[@]}

          if [ "$COUNT" -ne 1 ]; then
            echo "❌ Error: Debe subirse exactamente un archivo, se detectaron $COUNT."
            exit 1
          fi

          FILE=${FILES[0]}
          if [[ "$FILE" != *.sch ]]; then
            echo "❌ Error: El archivo '$FILE' no termina en .sch"
            exit 1
          fi

          echo "✅ Validación correcta: un solo archivo .sch"
