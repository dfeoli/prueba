name: Validate KiCad Push

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check if actor is admin
        id: check_admin
        run: |
          # ðŸ‘‡ Pon aquÃ­ tu usuario administrador real
          ADMIN_USER="dfeoliiii"

          echo "Actor que disparÃ³ el workflow: $GITHUB_ACTOR"
          if [ "$GITHUB_ACTOR" = "$ADMIN_USER" ]; then
            echo "is_admin=true" >> $GITHUB_ENV
          else
            echo "is_admin=false" >> $GITHUB_ENV
          fi

      - name: Get changed files
        if: env.is_admin == 'false'
        id: changed
        run: |
          # Obtener todos los archivos modificados entre el commit anterior y el actual
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})

          echo "Archivos modificados (raw):"
          echo "$CHANGED_FILES"

          # Filtrar archivos ignorados en .gitignore
          FILTERED=$(echo "$CHANGED_FILES" | grep -v -f <(git check-ignore -v $CHANGED_FILES | awk '{print $3}') || true)

          echo "Archivos modificados (filtrados):"
          echo "$FILTERED"

          # Guardar en variable de entorno
          echo "files=$FILTERED" >> $GITHUB_ENV

      - name: Validate only one KiCad schematic changed
        if: env.is_admin == 'false'
        run: |
          # Convertir a array
          IFS=$'\n' read -rd '' -a FILE_ARRAY <<<"${{ env.files }}"

          COUNT=${#FILE_ARRAY[@]}
          echo "Cantidad de archivos vÃ¡lidos modificados: $COUNT"

          if [ $COUNT -ne 1 ]; then
            echo "âŒ Se modificaron mÃ¡s de un archivo (o ninguno). Solo se permite uno."
            exit 1
          fi

          FILE="${FILE_ARRAY[0]}"
          if [[ ! "$FILE" =~ \.kicad_sch$ ]]; then
            echo "âŒ El archivo modificado no tiene extensiÃ³n .kicad_sch"
            exit 1
          fi

          echo "âœ… ValidaciÃ³n exitosa: se modificÃ³ un Ãºnico archivo .kicad_sch"
